<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAP | Placement Test Guide</title>
    <!-- Favicon da SLAP -->
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: DM Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Aplicando a fonte padrão e cores do Hub Pedagógico */
        html, body {
            height: 100%;
        }
        /* MUDANÇA: Fundo principal agora é branco */
        body {
            font-family: 'DM Sans', sans-serif;
            display: flex;
            flex-direction: column;
        }
        #app-container {
            flex: 1 0 auto;
        }
        main {
            flex-shrink: 0;
        }
        
        /* Estilos específicos para Ecrãs de Apresentação Escuros (Splash Screens) */
        .dark-splash {
            background-color: #1c1917; /* stone-900 */
            color: #f5f5f4; /* stone-100 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh; 
            text-align: center;
            padding: 2rem;
            /* CORREÇÃO: Força a largura máxima para 100% da viewport e centraliza o conteúdo */
            width: 100vw; 
            max-width: 100vw;
            position: fixed; /* Fixa o splash no ecrã para cobrir tudo */
            top: 0;
            left: 0;
        }
        /* Conteúdo interno da splash screen para limitar o texto */
        .dark-splash > div {
            max-width: 42rem;
            width: 100%;
            margin: 0 auto;
        }

        /* Estilos do Botão de Ação */
        .action-button {
             background-color: #F1D24B; 
             color: #44403c; /* stone-800 */
             border: none; 
             padding: 0.75rem 1.5rem; 
             border-radius: 9999px; 
             font-weight: 700; 
             cursor: pointer; 
             transition: background-color 0.2s, transform 0.2s;
             display: inline-flex;
             align-items: center;
             justify-content: center; /* Centraliza o conteúdo (texto/ícones) */
             gap: 0.5rem;
             text-decoration: none;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .action-button:hover:not(:disabled) {
            background-color: #eab308; /* Darker yellow */
            transform: translateY(-2px);
        }
        .action-button:disabled {
            background-color: #a8a29e; /* stone-400 */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .progress-bar-background {
            background-color: #e7e5e4; /* stone-200 */
            border-radius: 9999px;
            height: 1rem;
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-foreground {
            background-color: #F1D24B;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        
        /* Estilos para o campo de input */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: #f5f5f4; /* stone-100 */
            border: 2px solid #e7e5e4; /* stone-200 */
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #44403c;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #F1D24B;
        }

        /* Estilos para os botões de pontuação (Oral Assessment) */
        .score-button {
            padding: 0.5rem 0.75rem; 
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.2s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 90px;
        }
        .score-button .score-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        .score-button.selected {
            background-color: #F1D24B;
            border-color: #EAB308;
            color: #1c1917;
        }
        /* Mapeamento de cores para os 4 critérios */
        .score-button.score-0 { background-color: #fca5a5; color: #991B1B; } /* Red for 0 (Didn't Answer) */
        .score-button.score-1 { background-color: #FEE2E2; color: #991B1B; } /* Light Red for 1 (Weak Answer) */
        .score-button.score-2 { background-color: #FFFBEB; color: #92400E; } /* Yellow for 2 (Acceptable Answer) */
        .score-button.score-3 { background-color: #D1FAE5; color: #065F46; } /* Green for 3 (Strong Answer) */

        /* Estilo para a caixa de critérios */
        .criteria-box {
            background-color: #fefefe; /* Branco muito leve, mantém o destaque sobre o fundo agora branco */
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e7e5e4;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); /* Sombra muito suave */
        }
        /* Botões de Ação Secundária (Parar Teste e Pular Nível) */
        .stop-test-button {
            background-color: #ef4444; /* red-500 */
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4); 
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .stop-test-button:hover {
            background-color: #dc2626; /* red-600 */
            transform: translateY(-2px);
        }
        .stop-test-button:disabled {
            background-color: #fca5a5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .skip-level-button {
             background-color: #4f46e5; /* indigo-600 */
             color: white; 
             box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.4); 
             padding: 0.75rem 1.5rem;
             border-radius: 9999px;
             font-weight: 700;
             cursor: pointer;
             transition: background-color 0.2s, transform 0.2s;
        }
        .skip-level-button:hover {
            background-color: #4338ca; /* indigo-700 */
            transform: translateY(-2px);
        }
        
        /* Estilos do Grammar Grid (NOVO LAYOUT DE CARTÕES/GRID) */
        .grammar-grid-container {
            display: grid;
            gap: 1.5rem; /* Espaço entre os cartões */
            /* Layout de 1 coluna por padrão (mobile) */
            grid-template-columns: 1fr;
        }
        @media (min-width: 640px) { /* sm breakpoint (desktop/tablet) */
            /* Layout de 2 colunas para telas maiores */
            .grammar-grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .grammar-card {
            background-color: #fefefe; /* Branco muito leve para cards de gramática */
            border: 1px solid #e7e5e4;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            height: 100%; 
        }
        .grammar-topic-header {
            background-color: #f5f5f4; /* stone-100 */
            padding: 1rem;
            border-bottom: 1px solid #e7e5e4;
            font-weight: 700;
            color: #44403c;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            flex-grow: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .grammar-options-container {
            display: flex;
            justify-content: space-around;
            padding: 1rem;
        }
        .grammar-pill {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0.25rem;
            border-radius: 0.5rem; 
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            border: 2px solid transparent;
            min-width: 30%; 
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Cores das Pills */
        .grammar-pill[data-score="1"] { background-color: #fee2e2; color: #991B1B; } 
        .grammar-pill[data-score="2"] { background-color: #fffbe9; color: #92400E; } 
        .grammar-pill[data-score="3"] { background-color: #d1fae5; color: #065F46; } 

        /* Seleção das Pills */
        .grammar-pill.selected-1 { border-color: #ef4444; background-color: #fca5a5; }
        .grammar-pill.selected-2 { border-color: #eab308; background-color: #fde68a; }
        .grammar-pill.selected-3 { border-color: #10b981; background-color: #a7f3d0; }

        .grammar-icon {
            width: 20px;
            height: 20px;
            margin-bottom: 4px;
        }

        /* Estilo para as caixas de destaque de cor amarela/índigo (mantidas) */
        .highlight-box-yellow {
            background-color: #F1D24B;
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        .highlight-box-indigo {
             background-color: #eef2ff; /* indigo-50 */
             border-radius: 0.75rem;
             padding: 1.5rem;
        }

    </style>
</head>
<body class="bg-white text-stone-800"> <!-- MUDANÇA: Fundo do Body agora é branco (bg-white) -->

    <main id="app-container" class="flex items-center justify-center p-0 sm:p-0 min-h-screen w-full">
        
        <!-- SPLASH SCREEN 1: PASSWORD LOGIN (DARK BACKGROUND) -->
        <div id="splash-1-view" class="dark-splash shadow-none">
            <!-- Conteúdo da Splash, limitado pelo .dark-splash > div no CSS -->
            <div>
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="SLAP Logo" class="w-32 h-auto mx-auto mb-6 sm:mb-8 rounded-lg">
                <h1 class="text-4xl sm:text-5xl font-bold text-[#F1D24B] mb-6 sm:mb-8">
                    Placement Test Guide
                </h1>
                <p class="text-lg text-stone-400 mb-4">Acesso Exclusivo para Professores.</p>
                
                <!-- CORREÇÃO: Adicionado mx-auto para centralizar o bloco de senha/botão -->
                <div class="w-full max-w-sm mx-auto"> 
                    <input type="password" id="password-input" class="input-field mb-4" placeholder="Enter Secret Password" required>
                    <button class="action-button bg-[#F1D24B] text-stone-900 text-xl px-12 py-4 w-full" onclick="checkPassword()">
                        Acessar Guia
                    </button>
                    <p id="password-error" class="text-red-400 mt-3 hidden">Incorrect password. Please try again.</p>
                </div>
            </div>
        </div>

        <!-- SPLASH SCREEN 2: CONFIRMATION (DARK BACKGROUND) -->
        <div id="splash-2-view" class="dark-splash hidden shadow-none">
            <div>
                 <!-- CORREÇÃO: Removida a opacidade do logo (opacity-80) -->
                 <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294959/SLAP_TIPO_BRANCO_uvynbr.png" alt="SLAP Logo Branco" class="w-32 h-auto mx-auto mb-4 sm:mb-6">
                <h2 class="text-3xl sm:text-4xl font-bold text-white mb-6 sm:mb-8 max-w-lg mx-auto">
                    Teacher, o aluno está preparado para iniciar o teste?
                </h2>
                <!-- CORREÇÃO: Adicionado block mx-auto para centralizar o botão Start Test! -->
                <button class="action-button bg-stone-100 text-stone-900 text-lg px-10 py-3 block mx-auto" onclick="startQuiz()">
                    Start Test!
                </button>
            </div>
        </div>

        <!-- NOVO WRAPPER PARA CONTEÚDO CLARO (Mantém a limitação de largura e centralização) -->
        <div id="light-content-wrapper" class="w-full max-w-3xl mx-auto">
        
            <!-- Quiz View (LIGHT BACKGROUND) -->
            <div id="quiz-view" class="hidden w-full">
                 <!-- Wrapper mantido com ID, agora se mistura com o fundo branco -->
                 <div id="quiz-content-wrapper" class="p-6 sm:p-8 rounded-xl w-full"> 
                    <!-- Quiz content will be injected here by JS -->
                 </div>
            </div>
            
            <!-- GRAMMAR GRID VIEW (LIGHT BACKGROUND) -->
            <div id="grammar-grid-view" class="hidden w-full p-6 sm:p-8">
                <!-- MUDANÇA: Logo acima do título e título simplificado -->
                <div class="mb-6">
                    <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo Preto" class="w-24 h-auto mx-auto mb-4">
                    <h2 class="text-3xl font-bold text-stone-800 text-center">Grammar Grid</h2>
                </div>
                <p class="text-stone-600 mb-6">Use this grid to evaluate the student's mastery of key grammar points. Select Strong, Medium, or Weak for each topic based on your observation during the oral test.</p>
                
                <!-- NOVO CONTAINER COM GRID RESPONSIVO -->
                <div id="grammar-cards-container" class="grammar-grid-container">
                    <!-- Grammar topics will be injected here by JS -->
                </div>
                
                <div id="grammar-grid-result" class="hidden my-6 p-4 bg-yellow-50 rounded-lg border-l-4 border-[#F1D24B]">
                    <p class="font-bold text-stone-800">Grammar Grid Result: <span id="grammar-level" class="text-xl font-extrabold text-[#1c1917]"></span></p>
                    <p id="grammar-score" class="text-sm text-stone-600"></p>
                </div>

                <div class="flex flex-col sm:flex-row justify-end gap-3 mt-8 w-full">
                    <button onclick="goToResultView()" class="action-button bg-stone-800 text-white hover:bg-stone-900 w-full sm:w-1/2">Back to Test Result</button>
                    <button id="submit-grammar-grid" onclick="submitGrammarGrid()" class="action-button bg-stone-800 text-white hover:bg-stone-900 w-full sm:w-1/2" disabled>
                        Submit & Calculate Grammar Level
                    </button>
                </div>
            </div>


            <!-- RESULTADO FINAL (LIGHT BACKGROUND) -->
            <div id="result-view" class="hidden w-full p-8 text-center">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo Preto" class="w-32 h-auto mx-auto mb-6">
                <h2 class="text-3xl font-bold mb-4 text-stone-800">Assessment Finished!</h2>
                <p id="result-time" class="text-xl text-stone-600 mb-2 font-semibold"></p>
                <p id="result-score" class="text-xl text-stone-600 mb-4 font-semibold"></p>
                
                <div class="my-6 highlight-box-yellow">
                    <p class="text-2xl font-bold text-stone-900 mb-2">Estimated Level (Oral Test)</p>
                    <!-- MUDANÇA: Reduzindo o tamanho da fonte do nível no mobile (apenas text-4xl) -->
                    <p id="result-level" class="text-4xl sm:text-5xl font-extrabold text-stone-900 mb-2"></p>
                </div>
                
                <p id="result-message" class="text-stone-700 max-w-md mx-auto"></p>

                <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
                     <button onclick="restartQuiz()" class="action-button text-lg px-8 py-3 bg-stone-800 text-white hover:bg-stone-900">
                         Restart Test
                     </button>
                     <button onclick="goToGrammarGrid()" class="action-button text-lg px-8 py-3 bg-indigo-600 text-white hover:bg-indigo-700">
                         Grammar Grid
                     </button>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // --- CONSTANTES AND DOM ELEMENTS ---
        const CORRECT_PASSWORD = 'Slapkids1*';
        const splash1View = document.getElementById('splash-1-view');
        const splash2View = document.getElementById('splash-2-view');
        const quizView = document.getElementById('quiz-view');
        const lightContentWrapper = document.getElementById('light-content-wrapper'); // NOVO: Wrapper para conteúdo claro
        // Elemento para injetar o conteúdo
        const quizContentWrapper = document.getElementById('quiz-content-wrapper'); 
        const resultView = document.getElementById('result-view');
        const grammarGridView = document.getElementById('grammar-grid-view');
        
        let totalScore = 0;
        let currentQuestionIndex = 0;
        let studentScores = []; // Stores score for each question
        let timerInterval = null; // For the timer
        let startTime = 0; // Test start time
        let totalTimeElapsed = 0; // Total time in milliseconds
        
        // Unique key for the overall score
        const overallScoreKey = 'overallScore'; 
        
        // Stores grammar scores: { topicKey: scoreValue }
        let grammarScores = {}; 

        // --- QUIZ DATA (ORAL PROMPTS AND CRITERIA) ---
        
        const scoreValues = [
            { 
                value: 0, 
                label: 'Didn\'t Answer', 
                icon: '<svg class="score-icon text-red-700" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" /></svg>', 
                desc: '0 pt - O aluno não respondeu ou não conseguiu articular a resposta.' 
            }, 
            { 
                value: 1, 
                label: 'Weak Answer', 
                icon: '<svg class="score-icon text-red-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.9997 18.0001L2.99974 5.0001H20.9997L11.9997 18.0001Z" transform="rotate(180 11.9997 11.5001)"/></svg>',
                desc: '1 pt - Resposta fraca, uso incorreto ou falta de vocabulário básico.' 
            },    
            { 
                value: 2, 
                label: 'Acceptable Answer', 
                icon: '<svg class="score-icon text-yellow-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>',
                desc: '2 pts - Resposta aceitável, com erros mas a ideia é transmitida.' 
            },
            { 
                value: 3, 
                label: 'Strong Answer', 
                icon: '<svg class="score-icon text-green-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27Z"/></svg>',
                desc: '3 pts - Resposta forte, boa fluência e precisão gramatical.'
            }  
        ];
        
        // Max score per question is 3. Total 40 questions * 3 = 120 max points.
        
        const oralPrompts = [
            // Starter 1 (Pré-A1) - 5 Questões
            { level: 'Starter 1 (Pré-A1)', prompt: "What’s your name?" },
            { level: 'Starter 1 (Pré-A1)', prompt: "How old are you?" },
            { level: 'Starter 1 (Pré-A1)', prompt: "Where are you from?" },
            { level: 'Starter 1 (Pré-A1)', prompt: "Where do you live?" },
            { level: 'Starter 1 (Pré-A1)', prompt: "What do you like to do in your free time?" },
            
            // Starter 2 (A1) - 4 Questões
            { level: 'Starter 2 (A1)', prompt: "What do you usually do on weekends?" },
            { level: 'Starter 2 (A1)', prompt: "Can you describe your house?" },
            { level: 'Starter 2 (A1)', prompt: "Do you like living in your neighborhood? Why?" },
            { level: 'Starter 2 (A1)', prompt: "Let’s talk about plans! What will you do tomorrow?" },

            // Freshman 1 (A2) - 5 Questões
            { level: 'Freshman 1 (A2)', prompt: "What did you do yesterday?" },
            { level: 'Freshman 1 (A2)', prompt: "Talking about yesterday, I felt a huge headache when I was working. When you have a headache, what do you do?" },
            { level: 'Freshman 1 (A2)', prompt: "What’s your favorite part of your body? Why?" },
            { level: 'Freshman 1 (A2)', prompt: "Tell me about the last time you went to the supermarket. What did you buy?" },
            { level: 'Freshman 1 (A2)', prompt: "What should you lose your passport during an international trip?" },

            // Freshman 2 (A2+) - 5 Questões
            { level: 'Freshman 2 (A2+)', prompt: "When you were a child, what games did you play?" },
            { level: 'Freshman 2 (A2+)', prompt: "What could you do when you were ten years old?" },
            { level: 'Freshman 2 (A2+)', prompt: "How is Brazilian food different from American food?" },
            { level: 'Freshman 2 (A2+)', prompt: "What do you like about your school or college life?" },
            { level: 'Freshman 2 (A2+)', prompt: "What movie did you watch last week? What happened in it?" },

            // Sophomore 1 (B1) - 5 Questões
            { level: 'Sophomore 1 (B1)', prompt: "What is on your bucket list for the future?" },
            { level: 'Sophomore 1 (B1)', prompt: "Have you ever been to an airport? What happened there?" },
            { level: 'Sophomore 1 (B1)', prompt: "Do you prefer staying in a hotel or a hostel? Why?" },
            { level: 'Sophomore 1 (B1)', prompt: "What’s the weather like today?" },
            { level: 'Sophomore 1 (B1)', prompt: "If your friend spends too much money, what do you tell them?" },

            // Sophomore 2 (B1+) - 5 Questões
            { level: 'Sophomore 2 (B1+)', prompt: "Have you ever dreamed of travelling in time? Where would you go?" },
            { level: 'Sophomore 2 (B1+)', prompt: "What have you just done today before coming here?" },
            { level: 'Sophomore 2 (B1+)', prompt: "Have you been to the gym yet this week?" },
            { level: 'Sophomores 2 (B1+)', prompt: "What’s something unfair you see in your city?" },
            { level: 'Sophomore 2 (B1+)', prompt: "Can you tell me an English expression you like and what it means?" },

            // Junior 1 (B1+/B2 low) - 5 Questões
            { level: 'Junior 1 (B1+/B2 low)', prompt: "Who’s your hero? Why do you admire this person?" },
            { level: 'Junior 1 (B1+/B2 low)', prompt: "If you see an injured animal, what will you do?" },
            { level: 'Junior 1 (B1+/B2 low)', prompt: "Have you ever studied abroad or thought about it?" },
            { level: 'Junior 1 (B1+/B2 low)', prompt: "What do you do once in a blue moon?" },
            { level: 'Junior 1 (B1+/B2 low)', prompt: "If you won the lottery, what would you do?" },

            // Junior 2 (B2 low) - 5 Questões
            { level: 'Junior 2 (B2 low)', prompt: "Have you ever heard about a crime in the news? What happened?" },
            { level: 'Junior 2 (B2 low)', prompt: "When a friend is sad, what do you say to help?" },
            { level: 'Junior 2 (B2 low)', prompt: "Can you tell me about a cultural difference you’ve seen or heard of?" },
            { level: 'Junior 2 (B2 low)', prompt: "Where do you usually put your phone when you’re at home?" },
            { level: 'Junior 2 (B2 low)', prompt: "What’s something that’s right for you but wrong for others?" },
            
            // Senior 1 (B2) - 5 Questões
            { level: 'Senior 1 (B2)', prompt: "Have you ever seen a video go viral? What was it?" },
            { level: 'Senior 1 (B2)', prompt: "Who usually cooks at your home? Can you tell me how a favourite dish is made?" },
            { level: 'Senior 1 (B2)', prompt: "What clothing expression do you know? Can you use it in a story?" },
            { level: 'Senior 1 (B2)', prompt: "Tell me about something you regret from last year." },
            { level: 'Senior 1 (B2)', prompt: "Tell me something one of your parents said that you remember until this day." },

            // Senior 2 (B2 High) - 5 Questões
            { level: 'Senior 2 (B2 High)', prompt: "If you had studied more, how would your life be now?" },
            { level: 'Senior 2 (B2 High)', prompt: "Would you rather live in a big city or in the countryside? Why?" },
            { level: 'Senior 2 (B2 High)', prompt: "Has anything ever happened to you that you still think about today?" },
            { level: 'Senior 2 (B2 High)', prompt: "What happened when someone in your family passed away? (checking euphemism understanding)" },
            { level: 'Senior 2 (B2 High)', prompt: "What’s something your parents used to bring you when you were a child?" },
            
            // ACC (Advanced Conversation Class) - 1 Questão (OBS: para o ACC, o sistema de pontuação considerará as perguntas anteriores)
            { level: 'ACC', prompt: "Caso o prospect consiga responder todas as perguntas bem, ele está indicado para o nível ACC. (Este prompt serve apenas como lembrete final.)" }
        ];

        // Gramáticas baseadas na progressão do usuário (14 TÓPICOS AGORA)
        const grammarTopics = [
            // Starter 1 (Pré-A1) - 1 Topic
            { topic: "Verb To Be", minLevel: 'Starter 1 (Pré-A1)' },

            // Starter 2 (A1) - 3 Topics
            { topic: "Simple Present", minLevel: 'Starter 2 (A1)' },
            { topic: "Future Tenses (Will/Going To)", minLevel: 'Starter 2 (A1)' },
            { topic: "Present Continuous", minLevel: 'Starter 2 (A1)' }, 

            // Freshman 2 (A2+) - 3 Topics
            { topic: "Simple Past", minLevel: 'Freshman 2 (A2+)' },
            { topic: "Past Continuous", minLevel: 'Freshman 2 (A2+)' },
            { topic: "Superlatives & Comparatives", minLevel: 'Freshman 2 (A2+)' },

            // Sophomore 2 (B1+) - 1 Topic
            { topic: "Present Perfect", minLevel: 'Sophomore 2 (B1+)' },
            
            // Junior 1 (B1+/B2 low) - 1 Topic
            { topic: "Conditionals (Zero, First, Second)", minLevel: 'Junior 1 (B1+/B2 low)' },

            // Junior 2 (B2 low) - 2 Topics
            { topic: "Would (Conditionals/Habits)", minLevel: 'Junior 2 (B2 low)' },
            { topic: "Past Perfect", minLevel: 'Junior 2 (B2 low)' },

            // Senior 1 (B2) - 2 Topics
            { topic: "Complex Modal Verbs", minLevel: 'Senior 1 (B2)' },
            { topic: "Reported Speech", minLevel: 'Senior 1 (B2)' },

            // Senior 2 (B2 High) - 1 Topic
            { topic: "Mixed Conditionals / Euphemisms", minLevel: 'Senior 2 (B2 High)' },
        ];
        
        // Ícones para o Grammar Grid (Weak, Medium, Strong)
        const grammarIcons = {
            1: '<svg class="grammar-icon text-red-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.9997 18.0001L2.99974 5.0001H20.9997L11.9997 18.0001Z" transform="rotate(180 11.9997 11.5001)"/></svg>', // Down Arrow
            2: '<svg class="grammar-icon text-yellow-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>', // Circle
            3: '<svg class="grammar-icon text-green-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27Z"/></svg>' // Star
        };


        // --- TIMER FUNCTIONS ---
        
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            startTime = Date.now();
            totalTimeElapsed = 0; // Reset total time
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                totalTimeElapsed = Date.now() - startTime; 
            }
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            
            const pad = (num) => num.toString().padStart(2, '0');
            return `${pad(minutes)}:${pad(remainingSeconds)}`;
        }

        function updateTimerDisplay() {
            const msElapsed = Date.now() - startTime;
            const timerElement = document.getElementById('timer-display');
            if (timerElement) {
                timerElement.textContent = formatTime(msElapsed);
            }
        }

        // --- NAVIGATION AND AUTHENTICATION FUNCTIONS ---

        function hideAllViews() {
            splash1View.classList.add('hidden');
            splash2View.classList.add('hidden');
            // NOVO: Esconde o wrapper que contém as views claras
            lightContentWrapper.classList.add('hidden'); 
        }

        function startSplash1() {
            hideAllViews();
            splash1View.classList.remove('hidden');
        }
        
        window.checkPassword = function() {
            const input = document.getElementById('password-input');
            const errorMsg = document.getElementById('password-error');

            if (input.value === CORRECT_PASSWORD) {
                errorMsg.classList.add('hidden');
                goToSplash2();
            } else {
                errorMsg.classList.remove('hidden');
                input.value = ''; // Clear field
                input.focus();
            }
        }

        window.goToSplash2 = function() {
            hideAllViews();
            splash2View.classList.remove('hidden');
        }
        
        window.goToResultView = function() {
            hideAllViews();
            lightContentWrapper.classList.remove('hidden'); // Mostra o wrapper central
            resultView.classList.remove('hidden');
            quizView.classList.add('hidden');
            grammarGridView.classList.add('hidden');
        }

        window.goToGrammarGrid = function() {
            hideAllViews();
            lightContentWrapper.classList.remove('hidden'); // Mostra o wrapper central
            grammarGridView.classList.remove('hidden');
            quizView.classList.add('hidden');
            resultView.classList.add('hidden');
            renderGrammarGrid();
        }
        
        // --- QUIZ FUNCTIONS ---

        function startQuiz() {
            hideAllViews();
            lightContentWrapper.classList.remove('hidden'); // Mostra o wrapper central
            quizView.classList.remove('hidden');
            
            currentQuestionIndex = 0;
            totalScore = 0;
            // Clear and initialize score data
            studentScores = oralPrompts.map(q => ({
                ...q,
                scores: { [overallScoreKey]: null }
            }));
            
            // Reset Grammar Scores
            grammarScores = {}; 
            grammarTopics.forEach(topic => {
                grammarScores[topic.topic] = 0; // Default to 0 until scored (Weak is 1)
            });


            startTimer(); // Start the timer

            displayQuestion();
        }
        
        /**
         * Skips to the first question of the next distinct proficiency level.
         * All skipped questions in the current level are scored as 3 (Strong Answer).
         */
        window.skipToNextLevel = function() {
            if (currentQuestionIndex >= studentScores.length - 1) {
                showResult();
                return;
            }

            const currentLevel = studentScores[currentQuestionIndex].level;
            let nextIndex = -1;
            
            // 1. Find the index of the first question belonging to a different (higher) level
            for (let i = currentQuestionIndex + 1; i < studentScores.length; i++) {
                if (studentScores[i].level !== currentLevel) {
                    nextIndex = i;
                    break;
                }
            }

            let targetIndex = nextIndex !== -1 ? nextIndex : studentScores.length - 1;

            // 2. Score ALL questions from current index up to targetIndex - 1 as 3 (Strong Answer).
            for (let i = currentQuestionIndex; i < targetIndex; i++) {
                // Only score if not already scored (including being marked as skipped: -1)
                if (studentScores[i].scores[overallScoreKey] === null) { 
                    studentScores[i].scores[overallScoreKey] = 3; 
                }
            }

            currentQuestionIndex = targetIndex;
            
            // If we skip to ACC prompt, finish the test automatically
            if (currentQuestionIndex === studentScores.length - 1) {
                showResult();
            } else {
                displayQuestion();
            }
        }
        
        /**
         * Marks the current question as explicitly skipped, excluding it from level calculation.
         * The special score value is -1.
         */
        window.skipQuestion = function() {
            const questionData = studentScores[currentQuestionIndex];
            
            // Mark current question as ignored (-1)
            questionData.scores[overallScoreKey] = -1; 
            
            // Automatically move to the next question
            window.nextQuestion(); 
        }


        function displayQuestion() {
            // Alterado para injetar o conteúdo diretamente no wrapper da quiz view
            const quizContainer = quizContentWrapper; 
            if (currentQuestionIndex >= studentScores.length) {
                // If the end of the quiz is reached (passed the last ACC prompt), show the result
                showResult();
                return;
            }

            const questionData = studentScores[currentQuestionIndex];
            const totalQuestions = studentScores.length;
            const progressPercentage = ((currentQuestionIndex) / totalQuestions) * 100;
            
            const quizLogoUrl = "https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png"; 
            
            const currentScore = questionData.scores[overallScoreKey];
            
            // Render score buttons with SVGs
            const scoreButtons = scoreValues.map(score => {
                const isSelected = currentScore === score.value;
                // Disable if already scored/skipped (score is not null) AND it's not the selected value
                const isDisabled = currentScore !== null && currentScore !== score.value;
                const buttonClasses = `score-button score-${score.value} ${isSelected ? 'selected' : ''}`; 
                return `<button class="${buttonClasses}" onclick="setOverallScore(${score.value}, this)" ${isDisabled ? 'disabled' : ''}>
                            ${score.icon}
                            <span class="text-xs font-medium">${score.label}</span>
                        </button>`;
            }).join('');
            
            // NOVO BOTÃO: Skip This Question
            const skipQuestionButton = questionData.level === 'ACC' ? '' : `
                <button id="skip-q-button" 
                        class="score-button bg-stone-900 text-white hover:bg-stone-700 transition-none" 
                        onclick="skipQuestion()" 
                        ${currentScore !== null ? 'disabled' : ''}
                        style="min-width: 120px;">
                    <svg class="score-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                    <span class="text-xs font-medium">Skip Question</span>
                </button>
            `;

            const criteriaHtml = `
                <div class="mb-4 text-center">
                    <p class="font-bold text-stone-700 mb-2">Overall Answer Score</p>
                    <div id="overall-criteria" class="flex flex-wrap gap-2 justify-center">
                        ${scoreButtons}
                        ${skipQuestionButton} 
                    </div>
                </div>
            `;
            
            // Hide scoring buttons for the last prompt (ACC, which is only informational)
            const isLastPrompt = currentQuestionIndex === totalQuestions - 1;
            const scoringSection = isLastPrompt ? '' : `
                <!-- Criteria Box (MANTIDO PARA DESTAQUE INTERNO) -->
                <div class="criteria-box">
                    <!-- CORREÇÃO: Adicionado text-center ao h4 -->
                    <h4 class="text-xl font-bold text-stone-800 mb-4 border-b pb-2 text-center">Student Answer Evaluation</h4>
                    ${criteriaHtml}
                </div>
            `;

            // --- NAVIGATION BUTTONS ---
            
            // Check if overall score was given to enable the next button (any score value, even -1 for skipped)
            const scoredOrLastPrompt = isLastPrompt || questionData.scores[overallScoreKey] !== null;
            const nextButtonDisabled = scoredOrLastPrompt ? '' : 'disabled';
            const buttonText = isLastPrompt ? "Finish Test and Generate Level" : ((currentQuestionIndex < totalQuestions - 1) ? "Next Question" : "Finish Test");
            const nextFunction = (currentQuestionIndex < totalQuestions - 1) ? "nextQuestion()" : "showResult()";
            
            const stopTestButton = `
                <button class="stop-test-button text-lg px-8 py-3 w-full sm:w-auto" onclick="showResult(true)">
                    End Test Here and View Result
                </button>
            `;
            
            // Show skip button only if not on the last level (ACC is the last index)
            const isLastLevelBlock = questionData.level === oralPrompts[oralPrompts.length - 2].level || isLastPrompt;

            // REMOVIDO: Icone SVG do skip-level-button
            const nextLevelButton = !isLastLevelBlock ? `
                <button class="skip-level-button text-lg px-8 py-3 w-full sm:w-auto" onclick="skipToNextLevel()">
                    Skip to Next Level 
                </button>
            ` : '';

            quizContainer.innerHTML = `
                <div id="quiz-content">
                     <div class="flex justify-between items-center mb-6">
                        <img src="${quizLogoUrl}" alt="SLAP Logo Preto" class="w-24 h-auto">
                        <div class="text-3xl font-bold text-stone-800 p-2 border-2 border-stone-800 rounded-lg">
                            <span id="timer-display">00:00</span>
                        </div>
                     </div>
                     <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <div class="w-full sm:w-auto mb-3 sm:mb-0">
                            <p class="text-sm font-semibold text-stone-500 mb-1">Question ${currentQuestionIndex + 1} of ${totalQuestions}</p>
                            <div class="progress-bar-background">
                                <div class="progress-bar-foreground" style="width: ${progressPercentage}%;"></div>
                            </div>
                        </div>
                        <!-- Centralização do Nível Foco em Mobile/Desktop -->
                        <div class="text-center w-full sm:w-auto ml-0 sm:ml-4 p-2 bg-yellow-50 rounded-lg"> 
                            <p class="text-sm font-semibold text-stone-500">Nível Foco</p>
                            <span class="text-xl font-bold text-stone-900">${questionData.level}</span>
                        </div>
                     </div>
                    
                    <!-- Prompt for the Teacher (text in Portuguese as requested) -->
                    <div class="p-6 highlight-box-indigo mb-6">
                        <p class="text-sm font-semibold text-indigo-600 mb-2">PROMPT ORAL (Professor pergunta):</p>
                        <h3 class="text-xl sm:text-2xl font-bold text-indigo-800">${questionData.prompt}</h3>
                    </div>
                    
                    ${scoringSection}

                    <!-- REORGANIZAÇÃO: Ações secundárias à esquerda, Ação primária à direita -->
                    <div id="quiz-nav" class="mt-8 flex flex-col-reverse sm:flex-row items-center justify-between gap-4">
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            ${stopTestButton}
                            ${nextLevelButton}
                        </div>
                        <button class="action-button text-lg px-8 py-3 w-full sm:w-auto" onclick="${nextFunction}" ${nextButtonDisabled}>
                            ${buttonText} 
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline ml-1"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                    </div>
                </div>`;
            
            // Update progress bar after HTML injection
            setTimeout(() => {
                quizContainer.querySelector('.progress-bar-foreground').style.width = `${((currentQuestionIndex + 1) / totalQuestions) * 100}%`;
            }, 100);
            
            updateTimerDisplay();
        }

        window.setOverallScore = function(scoreValue, clickedButton) {
            const questionData = studentScores[currentQuestionIndex];
            
            questionData.scores[overallScoreKey] = scoreValue;
            
            const criteriaDiv = document.getElementById('overall-criteria');
            criteriaDiv.querySelectorAll('.score-button').forEach(button => {
                button.classList.remove('selected');
            });
            // Adiciona seleção ao botão de pontuação clicado
            clickedButton.classList.add('selected');
            
            // Desabilita o botão Skip Question após a pontuação
            const skipButton = document.getElementById('skip-q-button');
            if (skipButton) { skipButton.disabled = true; }
            
            const allScored = questionData.scores[overallScoreKey] !== null;
            const nextButton = document.querySelector('#quiz-nav .action-button:not(.stop-test-button)'); 
            if (nextButton) {
                nextButton.disabled = !allScored;
            }
        }

        window.nextQuestion = function() {
            currentQuestionIndex++;
            displayQuestion();
        }

        // --- GRAMMAR GRID FUNCTIONS ---
        
        function renderGrammarGrid() {
            const cardsContainer = document.getElementById('grammar-cards-container');
            cardsContainer.innerHTML = '';
            
            grammarTopics.forEach(topicData => {
                const topicKey = topicData.topic;
                const currentScore = grammarScores[topicKey] || 0; 
                
                const card = document.createElement('div');
                card.className = 'grammar-card';
                
                // Header
                card.innerHTML = `<div class="grammar-topic-header">${topicKey}</div>`;
                
                // Options Container
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'grammar-options-container';

                // Create score pills (1: Weak, 2: Medium, 3: Strong)
                [
                    { score: 1, label: 'Weak', icon: grammarIcons[1] },
                    { score: 2, label: 'Medium', icon: grammarIcons[2] },
                    { score: 3, label: 'Strong', icon: grammarIcons[3] }
                ].forEach(item => {
                    const pill = document.createElement('div');
                    const isSelected = currentScore === item.score;
                    
                    pill.className = `grammar-pill ${isSelected ? `selected-${item.score}` : ''}`;
                    pill.setAttribute('data-topic', topicKey);
                    pill.setAttribute('data-score', item.score);
                    
                    // Renderiza o ícone e o label
                    pill.innerHTML = `${item.icon}<span class="text-xs">${item.label}</span>`;
                    
                    pill.onclick = function() {
                        setGrammarScore(topicKey, item.score, this); 
                    };
                    optionsContainer.appendChild(pill);
                });
                
                card.appendChild(optionsContainer);
                cardsContainer.appendChild(card);
            });
            
            // If all topics are scored (all are > 0), enable the submit button
            checkGrammarGridCompletion();
        }
        
        window.setGrammarScore = function(topicKey, scoreValue, clickedPill) {
            // Update the score in the global object
            grammarScores[topicKey] = scoreValue;
            
            // Visual update: Remove seleção de todas as pills do mesmo tópico
            const optionsContainer = clickedPill.parentElement;
            optionsContainer.querySelectorAll('.grammar-pill').forEach(pill => {
                pill.classList.remove('selected-1', 'selected-2', 'selected-3');
            });
            
            // Adiciona seleção à pill clicada
            clickedPill.classList.add(`selected-${scoreValue}`);
            
            checkGrammarGridCompletion();
        }
        
        function checkGrammarGridCompletion() {
            const allScored = grammarTopics.every(topic => grammarScores[topic.topic] > 0);
            const submitButton = document.getElementById('submit-grammar-grid');
            if (submitButton) {
                submitButton.disabled = !allScored;
            }
            return allScored;
        }

        window.submitGrammarGrid = function() {
            if (!checkGrammarGridCompletion()) return;

            // Mapeamento dos 14 tópicos (Atualizado)
            const scores = {
                'Verb To Be': grammarScores['Verb To Be'] || 0,
                'Simple Present': grammarScores['Simple Present'] || 0,
                'Future Tenses (Will/Going To)': grammarScores['Future Tenses (Will/Going To)'] || 0,
                'Present Continuous': grammarScores['Present Continuous'] || 0,
                'Simple Past': grammarScores['Simple Past'] || 0,
                'Past Continuous': grammarScores['Past Continuous'] || 0,
                'Superlatives & Comparatives': grammarScores['Superlatives & Comparatives'] || 0,
                'Present Perfect': grammarScores['Present Perfect'] || 0,
                'Conditionals (Zero, First, Second)': grammarScores['Conditionals (Zero, First, Second)'] || 0,
                'Would (Conditionals/Habits)': grammarScores['Would (Conditionals/Habits)'] || 0,
                'Past Perfect': grammarScores['Past Perfect'] || 0,
                'Complex Modal Verbs': grammarScores['Complex Modal Verbs'] || 0,
                'Reported Speech': grammarScores['Reported Speech'] || 0,
                'Mixed Conditionals / Euphemisms': grammarScores['Mixed Conditionals / Euphemisms'] || 0,
            };

            let grammarLevel = 'Starter 1 (Pré-A1)'; // Default

            // REGRAS DE TRANSIÇÃO (AJUSTADAS PARA OS 14 TÓPICOS)
            
            // 1. STARTER 2 (A1)
            // Domínio: Verb to Be (>= 2). Conhecimento: Simple Present (>= 1), Future Tenses (>= 1), Present Continuous (>= 1)
            if (scores['Verb To Be'] >= 2 && scores['Simple Present'] >= 1 && scores['Future Tenses (Will/Going To)'] >= 1 && scores['Present Continuous'] >= 1) {
                grammarLevel = 'Starter 2 (A1)';
            }
            
            // 2. FRESHMAN 2 (A2+) - Domínio dos Presentes/Futuro e introdução do Passado
            // Domínio: Verb To Be (>= 3). Conhecimento: Simple Present (>= 2), Future Tenses (>= 2), Present Continuous (>= 2), Simple Past (>= 1)
            if (scores['Verb To Be'] >= 3 && scores['Simple Present'] >= 2 && scores['Future Tenses (Will/Going To)'] >= 2 && scores['Present Continuous'] >= 2 && scores['Simple Past'] >= 1) {
                 grammarLevel = 'Freshman 2 (A2+)';
            }
            
            // 3. SOPHOMORE 1 (B1) - DOMÍNIO DE PASSADO SIMPLES e CONTINUOUS
            // Domínio: Simple Past (>= 3), Past Continuous (>= 3). Conhecimento: Superlatives (>= 1)
            if (scores['Simple Past'] >= 3 && scores['Past Continuous'] >= 3 && scores['Superlatives & Comparatives'] >= 1) {
                grammarLevel = 'Sophomore 1 (B1)'; 
            }
            
            // 4. SOPHOMORE 2 (B1+) - Domínio de Passado, Comparativos/Superlativos e Present Perfect (Novo)
            // Domínio: Simple Past (>= 3), Past Continuous (>= 3), Superlatives (>= 2). Conhecimento: Present Perfect (>= 1)
            if (scores['Simple Past'] >= 3 && scores['Past Continuous'] >= 3 && scores['Superlatives & Comparatives'] >= 2 && scores['Present Perfect'] >= 1) {
                grammarLevel = 'Sophomore 2 (B1+)';
            }

            // 5. JUNIOR 1 (B1+/B2 low) - Domínio Present Perfect e Conditionals (Zero/First/Second)
            // Domínio: Present Perfect (>= 2). Conhecimento: Conditionals (Zero, First, Second) (>= 1)
            if (scores['Present Perfect'] >= 2 && scores['Conditionals (Zero, First, Second)'] >= 1) {
                grammarLevel = 'Junior 1 (B1+/B2 low)';
            }

            // 6. JUNIOR 2 (B2 low) - Domínio Condicionais e introdução Would/Past Perfect
            // Domínio: Conditionals (Zero, First, Second) (>= 2). Conhecimento: Would (>= 1), Past Perfect (>= 1)
            if (scores['Conditionals (Zero, First, Second)'] >= 2 && scores['Would (Conditionals/Habits)'] >= 1 && scores['Past Perfect'] >= 1) {
                grammarLevel = 'Junior 2 (B2 low)';
            }

            // 7. SENIOR 1/2 (B2) - Lapidação e Estruturas Complexas
            // Major Topics (5 Foundations): Verb To Be, Simple Present, Simple Past, Present Perfect, Conditionals (Zero, First, Second).
            const majorTopicsScored = [
                scores['Verb To Be'], 
                scores['Simple Present'], 
                scores['Simple Past'], 
                scores['Present Perfect'], 
                scores['Conditionals (Zero, First, Second)']
            ];
            const sumMajorScores = majorTopicsScored.reduce((a, b) => a + b, 0);
            const avgMajorScore = sumMajorScores / majorTopicsScored.length;

            // Se a média nos tópicos fundamentais for >= 2.5 (muito bom) E conhece Modals Complexos e Reported Speech (>= 2)
            if (avgMajorScore >= 2.5 && scores['Complex Modal Verbs'] >= 2 && scores['Reported Speech'] >= 2) {
                grammarLevel = 'Senior 1 / Senior 2 (Advanced)'; 
            }
            
            // TRATAMENTO DE SUB-NÍVEIS (Para refinar o resultado, se necessário)
            
            // Starter 2 -> Freshman 1: Se já domina Verb To Be (3) e Presentes (2), mas ainda falta base de passado.
            if (grammarLevel === 'Starter 2 (A1)' && scores['Verb To Be'] === 3 && scores['Simple Present'] >= 2) {
                 grammarLevel = 'Freshman 1 (A2) - (Needs practice on Simple Tenses)';
            } 
            // Sophomore 1 -> Freshman 2: Se domina Passado (3), mas não Comparatives/Superlatives (<= 1)
            else if (grammarLevel === 'Sophomore 1 (B1)' && scores['Superlatives & Comparatives'] <= 1) {
                grammarLevel = 'Freshman 2 (A2+) - (Needs strong focus on Comparatives/Superlatives)';
            }


            const maxGrammarScore = grammarTopics.length * 3; // 14 tópicos * 3 pontos = 42
            const totalGrammarScore = Object.values(scores).reduce((a, b) => a + b, 0);
            const averageScore = totalGrammarScore / grammarTopics.length; 

            document.getElementById('grammar-score').textContent = `Total Score: ${totalGrammarScore} / ${maxGrammarScore} pts (Average: ${averageScore.toFixed(2)})`;
            document.getElementById('grammar-level').textContent = grammarLevel;
            document.getElementById('grammar-grid-result').classList.remove('hidden');
        }


        // --- RESULT AND LEVEL CALCULATION FUNCTIONS ---

        function calculateLevel(quickFinish = false) {
            totalScore = 0;
            
            let scoredQuestions = studentScores.slice(0, currentQuestionIndex);
            
            if (!quickFinish && currentQuestionIndex < studentScores.length) {
                const lastQuestion = studentScores[currentQuestionIndex];
                if (lastQuestion.scores[overallScoreKey] !== null) {
                    scoredQuestions = studentScores.slice(0, currentQuestionIndex + 1);
                }
            }
            
            if (scoredQuestions.length > 0 && scoredQuestions[scoredQuestions.length - 1].level === 'ACC') {
                 scoredQuestions.pop();
            }

            // NOVO FILTRO: Remove questões que foram explicitamente puladas (-1)
            const validScoredQuestions = scoredQuestions.filter(q => (q.scores[overallScoreKey] !== null && q.scores[overallScoreKey] !== -1)); 

            const questionsAnswered = validScoredQuestions.length;
            
            // Recalcula totalScore usando apenas validScoredQuestions
            validScoredQuestions.forEach(q => {
                const questionScore = q.scores[overallScoreKey] || 0;
                // Como filtramos -1, podemos usar o score diretamente
                totalScore += questionScore; 
            });

            const maxScoreForAnswered = questionsAnswered * 3;
            const totalPossibleQuestions = oralPrompts.length - 1; // 40 valid questions
            
            let level = '';
            let message = '';
            
            if (questionsAnswered === 0) {
                 level = 'Starter 1 (Pré-A1)';
                 message = 'Teste interrompido antes de qualquer pontuação. Nível estimado: Starter 1.';
            } else {
                 const averageScore = totalScore / questionsAnswered;

                 // Map Average Score (0 to 3) to 9 levels
                 if (averageScore < 0.75) { level = 'Starter 1 (Pré-A1)'; message = 'O aluno demonstra conhecimento muito limitado e dificuldade em frases básicas. É indicado o nível Starter 1 para construir as bases.'; }
                 else if (averageScore < 1.05) { level = 'Starter 2 (A1)'; message = 'O aluno consegue usar o Presente Simples e vocabulário de sobrevivência, mas com erros frequentes. Deve consolidar as rotinas e introduzir o futuro/passado simples.'; }
                 else if (averageScore < 1.35) { level = 'Freshman 1 (A2)'; message = 'O aluno lida com tarefas simples, mas precisa de reforço no Passado Simples e no uso de "should". Foco em vocabulário cotidiano mais vasto.'; }
                 else if (averageScore < 1.65) { level = 'Freshman 2 (A2+)'; message = 'O aluno se comunica sobre o passado com alguma dificuldade, precisando de prática em "used to", "could" e sentenças comparativas. Bom para iniciar estruturas mais complexas.'; }
                 else if (averageScore < 1.95) { level = 'Sophomore 1 (B1)'; message = 'O aluno consegue dar conselhos e falar sobre experiências pessoais (Present Perfect), mas a fluência em tópicos mais amplos é limitada. Deve focar no Segundo Condicional.'; }
                 else if (averageScore < 2.25) { level = 'Sophomore 2 (B1+)'; message = 'O aluno usa o Present Perfect com "just" e "yet" e introduz expressões idiomáticas simples. Precisa de mais desenvoltura e precisão gramatical em temas complexos.'; }
                 else if (averageScore < 2.55) { level = 'Junior 1 (B1+/B2 low)'; message = 'O aluno consegue usar o Primeiro Condicional e introduzir expressões idiomáticas. O foco deve ser em aprimorar o discurso para lidar com temas abstratos e o Modal Perfect.'; }
                 else if (averageScore < 2.85) { level = 'Junior 2 (B2 low)'; message = 'O aluno demonstra boa fluência, mas precisa de vocabulário mais específico e phrasal verbs mais variados para expressar opiniões abstratas e lidar com diferenças culturais.'; }
                 else if (averageScore < 3.0) { level = 'Senior 1 (B2)'; message = 'O aluno tem um alto nível de comunicação. Deve focar em dominar o Third Conditional e o Reported Speech para refinar a precisão e complexidade sintática.'; }
                 else { level = 'ACC (Advanced Conversation Class)'; message = 'Parabéns! O aluno tem domínio avançado (B2 High / C1+), conseguindo usar Mixed Conditionals, Reported Speech e vocabulário sofisticado (eufemismos). Indicado para o nível Advanced Conversation Class (ACC).'; } // Score 3.0

                 if (quickFinish && questionsAnswered < totalPossibleQuestions) {
                    message = `⚠️ Teste interrompido após ${validScoredQuestions.length} questões avaliadas de ${totalPossibleQuestions} possíveis. A avaliação do nível foi feita com base nas respostas dadas. ${message}`;
                 }
            }


            return { 
                score: totalScore, 
                maxScore: maxScoreForAnswered, 
                level, 
                message, 
                answeredCount: questionsAnswered,
                totalPossible: totalPossibleQuestions
            };
        }

        window.showResult = function(quickFinish = false) {
            stopTimer(); // Stop the timer
            
            // If not a quick finish, ensure the last question score is saved (default to 0 if null, and not skipped)
            if (!quickFinish && currentQuestionIndex < studentScores.length) {
                const lastQuestion = studentScores[currentQuestionIndex];
                if (lastQuestion.scores[overallScoreKey] === null) {
                    lastQuestion.scores[overallScoreKey] = 0; 
                }
            }

            const resultData = calculateLevel(quickFinish);
            
            hideAllViews();
            lightContentWrapper.classList.remove('hidden'); // Mostra o wrapper central
            resultView.classList.remove('hidden');
            quizView.classList.add('hidden');
            grammarGridView.classList.add('hidden');

            const timeDisplay = formatTime(totalTimeElapsed);
            document.getElementById('result-time').textContent = `Total Assessment Time: ${timeDisplay}`;
            
            let scoreText;
            if (resultData.answeredCount < resultData.totalPossible) {
                scoreText = `Partial Score: ${resultData.score} of ${resultData.maxScore} pts evaluated (${resultData.answeredCount} questões válidas)`;
            } else {
                 scoreText = `Total Score: ${resultData.score} of ${resultData.maxScore} pts (${resultData.answeredCount} questões válidas)`;
            }
            document.getElementById('result-score').textContent = scoreText;

            document.getElementById('result-level').textContent = resultData.level;
            document.getElementById('result-message').textContent = resultData.message;
        }

        window.restartQuiz = function() {
            startSplash1();
            totalScore = 0;
            currentQuestionIndex = 0;
            studentScores = [];
            grammarScores = {};
            stopTimer();
            totalTimeElapsed = 0;
            startTime = 0;
            // Hide grammar grid results if they were visible
            document.getElementById('grammar-grid-result').classList.add('hidden');
        }

        // --- START FLOW ---
        window.onload = startSplash1;
    </script>
</body>
</html>
